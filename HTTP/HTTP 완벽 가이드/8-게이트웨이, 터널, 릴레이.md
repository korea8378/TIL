# HTTP 완벽 가이드

## 4월 2일

### 8장 게이트웨이, 터널, 릴레이

#### 개요
- HTTP 위에 다른 프로토콜을 얹으려고 하는 개발자들에게는 HTTP가 기본 구성 요소다.
- HTTP는 웹에 있는 모든 리소스에 대한 프로토콜로 사용됐으며, 애플리케이션 간에 서로 다른 프로토콜을 상호 운용하는 용도로 사용하기도 한다.
- 게이트웨이
    - 서로 다른 프르토콜과 애플리케이션 간의 HTTP 인터페이스다.
- 애플리케이션 인터페이스
    - 서로 다른 형식의 웹 애플리케이션이 통신하는 데 사용한다.
- 터널
    - HTTP 커넥션을 통해서 HTTP가 아닌 트래픽을 전송하는 데 사용한다.
- 릴레이
    - 일종의 단순한 HTTP 프락시로, 한 번에 한 개의 홉에 데이터를 전달하는 데 사용한다.

#### 게이트웨이
- 웹에 더 복잡한 리소스를 올려야 할 필요가 생기면서, 모든 리소스를 한 개의 애플리케이션만으로 처리할 수 없다는 것은 분명해졌다.
- 인터프리터 같이 리소스를 받기 위한 경로를 안내하는 역할을 하는 게이트웨이를 고안해냈다.
- 서버가 데이터베이스로 가는 게이트에이 역할을 할 수 있다.
- 게이트웨이는 HTTP 트래픽을 다른 프로토콜로 자동으로 변환하여, HTTP 클라이언트가 다른 프로토콜을 알 필요 없이 서버에 접속할 수 있게 하기도 한다.
    - HTTP/FTP 서버측 FTP 게이트웨이
    - HTTPS/HTTP 클라이언트 측 보안 게이트웨이
    - HTTP/CGI 서버 측 애플리케이션 게이트웨이

#### 클라이언트 측 게이트웨이와 서버 측 게이트웨이
- 웹 게이트웨이는 한쪽에서 HTTP로 통신하고 다른 한쪽에서는 HTTP가 아닌 다른 프로토콜로 통신한다.
- 게이트웨이는 클라이언트 측 프로토콜과 서버측 프로토콜을 빗금으로 구분해 기술한다.
- 서버 측 게이트웨이
    - 클라이언트와 HTTP 통신하고, 서버와는 외래 프로토콜로 통신한다.
- 클라이언트 측 게이트웨이
    - 클라이언트와 외래 프로토콜로 통신하고, 서버와는 HTTP로 통신한다.

#### 프로토콜 게이트웨이
- 프락시에 트래픽을 바로 보내는 것과 같이 게이트웨이에도 HTTP 트래픽을 바로 보낼 수 있다.
- 브라우저 명시적으로 게이트웨이를 설정하거나 게이트웨이를 대리 서버로 설정할 수 있다.
- HTTP/* : 서버측 게이트웨이
- HTTP/HTTPS : 서버 측 보안 게이트웨이
- HTTPS/HTTP : 클라이언트 측 보안 가속 게이트웨이

#### 리소스 게이트웨이
- 게이트웨이의 가장 일반적인 형태인 애플리케이션 서버는 목적지 서버와 게이트웨이를 한 개의 서버로 결합한다.
- 애플리케이션 서버는 HTTP를 통해서 클라이언트와 통신하고 서버 측에 있는 애플리케이션 프로그램에 연결하는 서버 측 게이트웨이다.
- 애플리케이션 게이트웨이에서 유명했던 최초의 API는 공용 게이트웨이 인터페이스였다.(CGI)
- CGI는 특정 URL에 대한 HTTP 요청에 따라 프로그램을 실행하고, 프로그램의 출력을 수집하고, HTTP 응답으로 회신하는데 웹 서버가 사용하는 표준화된 인터페이스 집합이다.
- 상용 웹 서버는 웹 서버와 애플리케이션 간의 통신에 사용할 정교한 인터페이스를 제공해왔다.

#### 공용 게이트웨이 인터페이스
- 공용 게이트웨이 인터페이스는 최초의 서버 확장이자 지금까지도 가장 널리 쓰이는 서버 확장이다.
- CGI 애플리케이션이 서버와 분리되면서 펄, Tcl, C, 다양한 셀 언어를 포함하여 수많은 언어로 구현할 수 있게 되었다.
- CGI가 내부에서 어떤 처리를 하는지 사용자에게 보이지 않는다.
- 사용자의 시각에서는 CGI가 내부적으로 일반적인 요청을 만드는 것일 뿐이다.
- 하지만 이런 분리 때문에 성능 관련한 비용이 발생했다. 모든 CGI 요청마다 새로운 프로세스를 만드는데 따르는 부하가 꽤 크고, CGI를 사용하는 서버의 성능을 제한하며 서버 장비에 부담을 준다.
- 이 문제를 피하고자 새로운 CGI 형식인, 그 이름도 적절한 Fast CGI가 개발되었다.

#### 서버 확장 API
- CGI 프로토콜은 구동 중인 HTTP 서버에 외부 인터프리터가 쉽게 접속할 수 있게 해주지만, 서버 자체의 동작을 바꾸고 싶거나 서버의 처리능력을 최고치로 끌어 올리고자 할 때는 어떻게 해야 할까?
- 서버 개발자는 웹 개발자가 자신의 모듈을 HTTP와 직접 연결할 수 잇는 강력한 인터페이스인 서버 확장 API를 제공하였다.
- 확장 API는 프로그래머가 자신의 코드를 서버에 연결하거나 서버의 컴포넌트를 자신이 만든 것으로 교체해버릴 수 있게 하였다.

#### 애플리케이션 인터페이스와 웹 서비스
- 웹 애플리케이션이 더 많은 형식의 서비스를 제공함에 따라, HTTP가 애플리케이션을 연결하는 도구로 활용할 수 있다는 게 더 확실해졌다.
- 애플리케이션을 연결하면서 생기는 까다로운 이슈중 하나는, 데이터를 교환하려는 두 애플리케이션 사이에서 프로토콜 인터페이스를 맞추는 일이다.
- 인터넷 커뮤니티는 각 웹 애플리케이션이 서로 통신하는데 사용할 표준과 프로토콜 집합을 개발하였다.
- 이러한 표준은 원래 웹 서비스가 독립형 웹 애플리케이션 그 자체를 의미함에도 불구하고, 그냥 그대로 웹 서비스로 불리게 되었다.

#### 터널
- 웹 터널은 HTTP 프로토콜을 지원하지 않는 애플리케이션에 HTTP 애플리케이션을 사용해 접근하는 방법을 제공한다.
- 웹 터널을 사용하면 HTTP 커넥션을 통해서 HTTP가 아닌 트래픽을 전송할 수 있고, 다른 프로토콜을 HTTP 위에 올릴 수 있다.
- 웹 터널을 사용하는 가장 일반적인 이유는 HTTP 커넥션 안에 HTTP가 아닌 트래픽을 얹기 위해서다.

#### CONNECT로 HTTP 터널 커넥션 맺기
- p.238~p239
- CONNECT 요청
- CONNECT 응답

#### 데이터 터널링, 시간, 커넥션 관리
- 터늘을 통해 전달되는 데이터는 게이트웨이에서 볼 수 없어서, 게이트웨이는 패킷의 순서나 흐름에 대한 어떤 가정도 할 수 없다.
- 터널이 일단 연결되면, 데이터는 언제 어디로든 흘러가버릴 수 있다.
- 게이트웨이는 커넥션이 맺어지는 대로 헤더를 포함해서 읽어들인 모든 데이터를 서버에 전송해야한다.(데이터를 전달만 해주는 역할을 하기 때문에)

#### SSL 터널링
- 웹 터널은 원래 방화벽을 통해서 암호화된 SSL 트래픽을 전달하려고 개발되었다.
- SSL 같이 암호화된 프로토콜은 정보가 암호화되어 있기 때문에 낡은 프락시에서는 처리되지 않는다.
- 터널을 사용하면 SSL 트래픽을 HTTP 커넥션으로 전송하여 80 포트의 HTTP만을 허용하는 방화벽을 통과시킬 수 있다.
- SSL 트래픽이 기존 프락시 방화벽을 통과할 수 있도록 HTTP에 터널링 기능이 추가되었다.

#### SSL 터널링 vs HTTP/HTTPS 게이트웨이
- HTTP/HTTPS 게이트웨이 단점
    - 클라이언트 게이트웨이 사이에 보안이 적용되지 않는 일반 HTTP 커넥션이 맺어져 있다.
    - 프락시가 인증을 담당하고 있기 때문에, 클라이언트는 원격 서버에 SSL 클라이언트 인증을 할 수 없다.
    - 게이트웨이는 SSL을 완벽히 지원해야 한다.
- SSL 터널링을 사용하면, 프락시에 SSL을 구현할 필요가 없다.

#### 터널 인증
- 프락시 인증 기능은, 클라이언트가 터널을 사용할 수 있는 권한을 검사하는 용도로 터널에서 사용할 수 있다.

#### 터널 보안에 대한 고려사항들
- 터널의 오용을 최소화하기 위해서, 게이트웨이는 HTTPS 전용 포트인 443 같이 잘 알려진 특정 포트만을 터널링 할 수 있게 허용해야 한다.

#### 릴레이
- HTTP 릴레이는 HTTP 명세를 완전히 준수하지는 않는 간단한 HTTP 프락시다.
- 릴레이는 커넥션을 맺기 위한 HTTP 통신을 한 다음, 바이트를 맹목적으로 전달한다.
- HTTP는 복잡하기에, 모든 헤더와 메서드 로직을 수행하지 않고 맹목적으로 트래픽을 전달하는 간단한 프락시를 구현하는 방식이 유용할 때가 있다.
- 하지만 이는 잠재적으로 심각한 상호 운용 문제를 가지고 있기 때문에 주의해서 배포해야 한다.

