# 프로젝트 성패를 결정짓는 데이터 모델링 이야기

## 3월 8일

### 14.관계선 긋기의 진정한 의미는 이것이다.

#### 데이터 모델에서의 관계
- 데이터 모델에서의 관계를 명확하게 정희하기는 쉽지 않다.
- 관계
    - 관계는 엔터티 사이에 존재하는 연관성으로, 모델에서는 관계선으로 표현되며 상위 엔터티의 주 식별자가 하위 엔터티의 속성으로 관리는 되는 것이다.
- 관계가 RDB에서는 속성이므로, 결국 참조무결성으로 구현된다.
- 참조 무결성
    - 기본 키와 참조 키 간의 관계가 항상 유지됨을 보장합니다.
    - 참조되는 테이블의 행을 이를 참조하는 참조키가 존재하는 한 삭제될 수 없고, 기본키도 변경될 수 없습니다.
- RDB의 특징은 크게 표 구조의 릴레이션, 컬럼과 행 위치의 자유로움, 키 상속 시에만 데이터 중복 허용, 이렇게 세가지로 규정할 수 있다.
- 엔티티 사이의 관계가 둘 이상이면 잘못된 것으로 아는 사람도 더러 있는데, 절대 그렇지 않다.

#### 데이터 모델링에서 관계가 어떤 의미를 가지는지 다양한 각도에서 정리해보자
- 1. 엔터티 간의 관련 여부를 알 수 있다.
    - 관계션이 전혀 없이 테이블만 500개인 물리 모델을 상상해보면 수긍이 될 것이다.
    - DB에서 테이블을 리버스해서 얻은 모델을 관계선 없이 이해하기란 제아무리 모델링 고수라 해도 어려운 일이다.
    - 관계썬은 업무를 이해하고 분석하는 데 굉장히 중요한 수단이다.
    - 관계선이 있으면 관련된 엔터티만 집중해서 분석할 수 있다.
- 2. 엔터티 간의 종속성을 알 수 있다.
    - 집합 간의 종속성, 계층구조의 명확한 이해는 데이터 모델을 큰 틀에서 볼 수 있는 좋은 관점을 제공한다.
- 3. 데이터가 발생하는 규칙을 알 수 있다
    - 정확히 표현된 관계선은 어떤 식으로든 엔터티 간의 업무 규칙을 보여준다.
- 4. SQL의 조인이 경로와 조회 결과 집합의 형태를 알 수 있다.
    - 관계선은 데이터를 조회할 때 조인하는 경로가 된다.
    - 관계선으로 연결된 상위 엔터티와 조인해야 속성을 기준으로 같은 데이터만 조인 결과로 가져오게 된다.
    - 또한 관계의 카디널리티를 통해 결합될 집합을 알 수 있다.
    - 1:M 관계의 집합을 조인한 결과는 M쪽 집합의 행 단위가 된다.
- 5. 참조무결성 관계를 알 수 있다.
    - 즉, 외래 키 속성의 값은 상위 엔터티의 주 식별자 값과 일치하거나 NULL이어야 한다.
    - 관계선으로 연겱된 두 엔터티의 연관된 인스턴스 사이에 이러한 일관성을 유지할 필요가 없다면 연결된 관계선은 잘못된 것이다.
    - 다시 말해 참조무결성 관계가 있을 때만 관계선을 그어야 한다.
    - 관계는 결국 부모의 식별자가 전달된 속으로 남는다.

#### 잘못 표현된 관계와 문제들
- 개발 현장에서는 이러저러한 핑계로 관계가 제대로 표현되지 않는 것이 사실이다.
- 그럼에도 불구하고 시스템 운용에 큰 문제가 생기지 않는 것을 보며 관계라는 것이 그리 중요한 것은 생각할 수도 있다.
- 관계 유무와 그 표현 방법의 가능한 조합
    - 1. 관계선 표현
        - 1.1 실제 관계가 있음(옳음)
        - 1.2 실제 관계가 없음
    - 2. 관계선 미표현
        - 2.1 관계 속성이 있음
        - 2.2 관계 속성이 없음
    - 2.2 실제 관계가 없음(옳음)
- 관계가 계층적일 때 2촌 이상과 직접 관계선을 그리며, 경우에 따라 무결성이 보장되는 값의 커버리지에 문제가 생길 수 있음을 정확히 인지 해야 한다.
- 관계선을 하나 긋는 행위가 데이터 무결성을 깨드릴 수도 있음을 충분히 이해해야 한다.
- 일반적으로 분석, 집계, 백업 성격의 데이터는 관계가 없는 경우가 많다.
- 참조 무결성 제약이 존재하는 관계만 관계선으로 표현되어야 한다.

#### 관계의 유형에 대한 고찰, 모델링 툴의 한계와 현실적인 방법
- 관계는 엔터티 사이에 존재하는 연관성으로, 모델에서는 관계선으로 표현되며 상위 엔터티의 주 식별자가 하위 엔터티의 속성으로 관리되는 것
- 데이터 모델 상에 관계선을 그을 수는 없지만, 개념적으로는 분명 관계가 존재하는 경우도 있다.
- 관계와 관련된 중요한 이슈
    - 1. 관계에는 EQUAL, NOT EQUAL, LIKE, BETWEEN 등 다양한 패턴이 있다.
    - 2. EQUAL 외의 관계는 DBMS의 참조무결성 제약으로 구현이 불가능하며, 애플리케이션에서 로직으로 처리해야 한다.
    - 3. EQUAL 외의 관계를 표현할 수 있는 모델링 툴은 많지 않다.
    - 4. 데이터 규칙을 최대한 표현한다는 관점에서, 툴에서 지원하지 않는 관계는 설명 상자등으로 기술하는 것이 적극적인 대응이라 생각된다.
    - 5. 관계는 엔터티 사이에 존재하는 연관성으로, 모델에서는 관계선으로 표현되며 상위 엔터티의 주 식별자가 하위 엔터티의 속성으로 관리는 되는 것이다. <- 이 정의는 관계의 현실적 정의 정도로 이해하면 좋을 것이다.

#### 코드와 관계, 그리고 참조 무결성 제약
- 코드라 무엇일까?
    - 정보를 나타내기 위한 기호 체계
    - 어떤 정보를 그대로 사용하면 불편하니 기호 체계로 변경해서 사용하기로 하고, 이때 변경된 모습의 기호가 바로 코드인 것이다.
- 데이터 모델에서 정보는 속성 단위로 입력되니 속성의 값을 기호로 변환한 것을 코드라고 할 수 있다.
- 그룹핑해서  집계하고 분석한 정보를 사용하려는 요건이 있을 경우 해당 속성 데이터를 코드로 표준화하여 관리하게 된다.
- 그래서 SQL 문장의 group by 절에 나오는 컬럼의 정체가 코드일 확률은 90% 이상이다.
- 공통 코드
    - 코드성 테이블을 한 단계 추상화한 것 공통코드 테이블이다.
    - 테이블의 기본 키가 코드 성격의 컬럼이며 관리하는 부가 정보가 많지 않을 경우 독립된 테이블보다는 공통코드 테이블로 일반화하는 쪽이 더 많은 장점을 취할 수 있다.
    - 자주 사용되는 코드가 하나의 테이블로 응집되어 메모리에 상주한다면 디스크 I/O가 줄어들어 더 빠른 처리가 이루어진다.
    - 반면에 코드 성격의 데이터지만 관리하는 속성이 많아 별도의 엔터티로 등록하는 경우가 목록 엔터티며, 부서코드가 대표적이다.
- 공통 코드와 관계선은 생략해도 무방하다는 설명은 잘 못된 것이다. 실상은 엔터티 사이에 관계 자체가 없기 때문이라는 표현이 정확하다.
- 관계선은 상위 엔터티의 주 식별자가 하위 엔터티의 관계 속성으로 내려오는 참조무결성 관계가 존재할 때만 표현되어야 한다.

#### 외래키 제약을 걸지 않는 이유
- 성능 저하
- 개발 생산성 저하
- 관리 불편
- 환경 제약

#### 외래키 제약을 걸지 않는것이 잘못된 이유
- 외래 키를 포함해서 DBMS가 데이터 무결성을 지키기 위해 제공하는 다양한 제약을 사용하지 않는 단골 이유가 바로 성능이다.
- 데이터 입력, 수정, 삭제 시 제약이 걸려 있다면 조건을 확인하기 위한 내부 트리거 부하가 동반되어 더 느리게 처리 될 수 밖에 없다.
- 그러나 성능이 너무 중요하여 데이터 무결성을 포기하거나 사후 대응해야만 하는 경우는 3% 미만이다.
- 일반적인 개발 조직에서 개발자, DA, DBA는 그 역할이 명확히 구분된다. 그래서 인지 애플리케이션 개발자는 데이터 무결성이니 외래 키니 하는 DB 안쪽 세계까지 깊이 고민하지 않는다.

#### 외래 키 관련 논쟁
- 1. 데이터 무결성이 중요하지 않은 업무라면 외래 키를 걸지 않아도 무방하다. 그러나 현실 업무에서는 그런 경우는 없다. 결국 외래 키 제약 구현은 전방위적으로 충분히 검토되어야 한다.
- 2. 성능 이슈가 있는 3% 미만의 영역에서는 외래 키를 걸지 않고, 무결성은 애플리케이션에서 보장하거나 사후 처리하는 방법을 검토할 수 있다.
- 3. 무결성이 중요하고 성능 이슈가 크지 않은 업무는 가능한 한 모두 외래 키를 걸도록 하자.
- 4. 관리상의 불편과 조직 내의 저항등에 부딪히면 무결성 유지가 최고의 가치가 될 만한 핵심 업무 중심으로 선택과 집중하여 외래 키를 반영하도록 하자.

#### 데이터 무결성 유지
- 관계형 데이터베이스에서 데이터 무결성 유지는 최고의 선택이라고 할 수 있으며, 이를 수호하기 위해 제공하는 참조무결성 제약은 당연히 최대한 활용해야 한다.
- 데이터 모델 설계 시 데이터 전문가 참여하여 컬럼 수준의 제약 조건을 적용해서 오류 데이터의 진입을 최대한 막는 것이 훨씬 효율적이다.
- 제약 조건은 시스템 규모 DML/조회 패턴, 트랜잭션 유형 등을 고려해서 적용 범위를 조정하는 등 융통성 있게 활용하도록 하자.
