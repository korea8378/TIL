# 2021-07-17

# 2장 도커 엔진(2)

## 도커이미지
- 모든 컨테이너는 이미지를 기반을 ㅗ생성되므로 이미지를 다루는 바업은 도커 관리에서 빼놓을 수 없는 부분입니다.
- 이미지의 이름을 구성하는 저장소, 이미지 이름, 태그를 잘 관리하는 것뿐만 아니라 이미지가 어떻게 생성되고 삭제되는지, 이미지의 구조는 어떻게 돼 있는지 등을 아는 것 또한 중요합니다.
- 도커 허브
    - 깃 허브와 같은 도커 이미지 저장소
- 도커 사설레지스트리
    - 자체적으로 도커 저장소를 구축하는 법

## 도커 이미지 구조 이해
- 도커 이미지를 좀 더 효율적으로 다루기 위해 컨테이너가 어떻게 이미지로 만들어지며, 이미지의 구조는 어떻게 돼 있는 알 필요가 있습니다.
- docker inspect
    - 도커 이미지의 메타정보를 확인
- 컨테이너 레이어
    - 도커 이미지는 레이어를 통해 이루어져 있다.
    - 레이어를 쌓으면서 최종 도커 이미지를 만듬
        - 재사용
- 이미지 추출
    - 도커 이미지를 바이너리 파일로 추출 가능
    - save, load, import, export
- 이미지 배포
    - 도커 허브나 사설레지스트리에 이미지를 배포가능

## 도커 파일 작성
- 도커파일은 도커를 위한 특수한 파일인 만큼 기존의 스크립트 언어와 비교했을 때 완전히 새로운 방식으로 쓰이지만 컨테이너에서 사용되는 기초적인 명령어를 알기 쉽게 변환한 것이므로 어렵지 않게 익힐 수 있습니다.
- FROM
    - 기반이 도커 이미지
- MAINTANER
    - 이미지를 생성한 개발자의 정보
- LABEL
    - 이미지에 메타데이터 추가
- RUN
    - 이미지를 만들기 위해 컨테이너 내부에서 명령어를 실행
- ADD
    - 파일을 이미지에 추가
- WORKDIR
    - 명령어를 실행할 디렉토리를 나타냄
- EXPOSE
    - 빌드로 생성된 이미지에서 노출할 포트
- CMD
    - 컨테이너가 시작될 때마다 실행할 명령어 

## 빌드 과정 살펴보기
- Build 명령어를 입력했을때 다양한 내용이 출력됩니다.
- 내용 중 대부분 dockerfile의 run을 실행해서 컨테이너 내부에서 발생한 표준 출력이지만 이미지를 생성하는 부분은 조금 눈여겨볼필요가 있습니다.
- 이미지를 빌드를 시작하면 도커는 가장 먼저 빌드 컨텍스트를 읽어 들입니다.
- 빌드컨텍스트
    - 이미지를 생성하는 데 필요한 각종 파일, 소스코드, 메타데이터 등을 담고 디렉터리를 의미하며, dockerfile이 위치한 디렉터리가 빌드 컨텍스가 됩니다.
- .dockerignore
    - .gitignore와 같은 역할 
    - 빌드시 제외할 컨텍스트 목록
- 빌드시 각 step은 도커파일에 기록된 명령에 해당합니다.
- 이미지의 빌드가 완료되면 dockerfile의 명령어의 줄 수만큼의 레이어가 존재하게 되며, 중간에 컨테이너도 같은 수만큼 생성되도 삭제됩니다.

## 캐시를 이용한 빌드
- 빌드시 Using cache라는 출력 내용과 함께 별도의 빌드 과정이 진행되지 않고 바로 이미지가 생성됩니다.
- 이전에 빌드했던 도커파일에 같은 내용이 있다면 build 명령어는 이르 새로 빌드하지 않고 같은 명령어 줄까지 이전에 사용한 이미지 레이어를 그대로 사용합니다.
- 이는 같은 명령어를 여러 번 실행해야 하는 여러 개의 이미지를 빌드하거나 빌드 도중 Dockerfile의 문법과 기타 오류가 발생했을때 불필요하게 다시 명령어를 실행하지 않게 합니다.
- 캐시를 이용하지 않고 싶을때
    - git clone과 같이 깃에 저장되어 있는 소소코드가 변했을때와 같이 캐시되어 있는 그전 소스코드를 사용하면 안될때가 있다.
    - -- no-cache 옵션을 추가하여 캐시된 이미지를 사용하지 않을 수 있다.

## 멀티 스테이지 이용한 도커파일 빌드하기
- 하나의 도커파일에 여러 개의 FROM 이미지를 사용할 수 있다.
- 빌드하는 환경과 실행하는 환경을 구분하여 용량을 크게 줄일 수 있다.
    - ex) 빌드시 필요한 각종 의존성들이 큰용량을 차지하고 있고 빌드된 파일을 실행시에는 불필요할 때

## 기타 도커 명령어
- ENV
    - 도커파일에서 사용될 환경변수
- VOLUME
    - 빌드된 이미지로 컨테이너를 생성했을 때 호스트와 공유할 컨테이너 내부의 디렉토리를 설정
- ARG
    - Build 명령어를 실행할 때 추가로 입력을 받아 dockerfile 내에서 사용될 변수의 값을 설정
- USER
    - 컨테이너 내에서 사용될 사용자 계정의 이름이나 UID를 설정하면 그 아래의 명령어는 해당 사용자 권한으로 실행
- Onbuild
    - 빌드된 이미지를 기반으로 하는 다른 이미지가 Dockerfile로 생성 될때 실행할 명령어를 추가
- Stopsignal
    - 컨테이너가 정지될 때 사용될 시스템 콜의 종류를 지정
- Healthcheck
    - 이미지로부터 생성된 컨테이너에서 동작하는 애플리케이션의 상태를 체크하도록 설정
- Shell
    - 도커파일에서는 기본적으로 사용하는 셀을 변경할때
- COPY
    - 로컬 디렉토리에서 읽어 들인 컨텍스트로부터 이미지에 파일을 복사하는 역할
- ENTRYPOINT
    - CMD와 동일하게 동작
    - https://bluese05.tistory.com/77

## 도커파일을 빌드할때 주의할점
- https://cloud.google.com/architecture/best-practices-for-building-containers?hl=ko
