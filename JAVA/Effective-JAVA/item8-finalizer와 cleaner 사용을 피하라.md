# JAVA

## 6월 7일

### 아이템8.finalizer와 cleaner 사용을 피하라

#### 자바의 객체 소멸자
- 자바는 두 가지 객체 소멸자를 제공한다.

#### finalizer
- finalizer는 예측할 수 없고, 상황에 따라 위험할 수 있어 일반적으로 불필요하다.
- 오동작, 낮은 성능, 이식성 문제의 원인이 되기도 한다. finalizer는 나름의 쓰임새가 몇 가지 있기 하지만 기본적으로 `쓰지 말아야` 한다.
- 자바 9에서는 사용 자제 API로 지정

#### cleaner
- cleaner는 finalizer보다는 덜 위험하지만, 여전히 예측할 수 없고, 느리고 , 일반적으로 불필요하다.

#### finalizer & cleaner
- finalizer와 cleaner는 즉시 수행된다는 보장이 없다.
- 객체에 접근 할 수 없게 된 후 finalizer와 cleaner가 실행되기까지 얼마나 걸리지 알 수 없다.
- 즉 `finalizer와 cleaner로는 제때 실행되어야 하는 작업은 절대 할 수 없다.`
- 파일 닫기를 finalizer나 cleaner에 맡기면 중대한 오류를 일으킬 수 있다.
    - 시스템이 동시에 열 수 이쓴 파일 개수에 한계가 있기 때문이다.
- finalizer나 cleaner를 얼마나 신속히 수행할지는 전적으로 가비지 컬렉터 알고리즘에 달렸으며, 이는 가비지 컬렉터 구현마다 천차만별이다.
- finalizer 스레드는 다른 애플리케이션 스레드보다 우선 순위가 낮아서 실행될 기회를 제대로 얻지 못한다.
    - finalizer를 사용하지 말자. 
- 자바 언어 명세는 finalizer나 cleaner의 수행 시점뿐 아니라 수행 여부조차 보장하지 않는다.
- `상태를 영구적으로 수정하는 작업에서는 절대 finalizer나 cleaner에 의존해서는 안 된다.`
- 예외처리도 보장 하지 못한다. (스택 추적 내역도 출력 하지 않는다.)
- `finalizer와 cleaner는 심가한 성능 문제도 동반한다.`
- `finalizer를 사용한 클래스는 finalizer 공격에 노출되어 심가한 보안 문제를 일으킬 수도 있다.`

#### finalizer와 cleaner가 존재하는 이유
- 첫 번째, 자원의 소유자 close 메서드를 호출하지 않는 것에 대비한 안전망 역할이다.
    - 즉시 호출되리라는 보장은 없지만, 클라이언트가 하지 않은 자원 회수를 늦게라도 해주는 것이 아예 안 하는 것보다는 낫다.
    - 자바 라이브러리의 일부 클래스는 안전망 역할의 finalizer를 제공한다.
        - ex) FileInputStream, FileOutputStream, ThreadPoolExecutor
- 두 번째, 네이티브 피어와 연결된 객체에서다.
    - 네이티브 피어란 일반 자바 객체가 네이티브 메서드를 통해 기능을 위임한 네이티브 객체를 말한다.
    - 네이티브 피어는 자바 객체가 아니니 가비지 컬렉터는 그 존재를 알지 못한다. 그 결과 자바 피어를 회수 할 때 네이티브 객체까지 회수하지 못한다.
    - 성능 저하를 감당할 수 없거나 네이티브 피어가 사용하는 자원을 즉시 회수해야 한다면 앞서 설명한 close 메서드를 사용해야 한다.

#### 핵심 정리
- `cleaner(자바 8까지는 finalizer)는 안전망 역할이나 중요하지 않은 네이티브 자원 회수용으로만 사용하자.`
- `하지만 이런 경우 불확실성과 성능 저하에 주의해야 한다.`
